FROM registry.access.redhat.com/ubi9/nodejs-22:latest
      
USER 0

# ENV NODE_ENV=production
      
# Install git for cloning and any additional dependencies
RUN dnf update -y && \
dnf install -y git python3 make gcc-c++ && \
dnf clean all
      
# Set working directory
WORKDIR /app
      
# Copy package files
COPY package*.json ./
      
# Install dependencies
RUN npm ci && \
npm cache clean --force
# RUN npm install -g @vue/cli-service --save-dev && npm install -g @vue/cli-plugin-babel &&  npm install -g @vue/cli-plugin-eslint && npm install -g @vue/cli-plugin-pwa
      
# Copy application code
COPY . .
      
# Build the application (if needed)
RUN if [ -f "package.json" ] && [ -n "$(npm run | grep build)" ]; then npm run build; fi
      
# Create non-root user
RUN useradd -r -u 1001 -g root recommendarr
RUN chown -R 1001:0 /app && \
chmod -R g=u /app
      
USER 1001
      
# Expose port
EXPOSE 3000
      
# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
      
# Start the application
CMD ["npm", "start"]
